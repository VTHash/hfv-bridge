"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getWalletBalances = void 0;
const AlchemyClient_js_1 = __importDefault(require("./AlchemyClient.js"));
const GoldRushClient_js_1 = __importDefault(require("./GoldRushClient.js"));
const DEFAULT_TIMEOUT_MS = 5000;
async function tryClient({ client, network, chain, walletAddr, name, timeoutMs = DEFAULT_TIMEOUT_MS, }) {
    if (!client) {
        return null;
    }
    try {
        if (!client.supportsChain(network, chain)) {
            console.info(`Network=${network} Chain=${chain} not supported by ${name} indexer API`);
            return null;
        }
        const controller = new AbortController();
        const timeout = setTimeout(() => {
            controller.abort(new Error(`${name} request timed out after ${timeoutMs}ms`));
        }, timeoutMs);
        let balances;
        try {
            balances = await client.getBalances(network, chain, walletAddr, controller.signal);
        }
        finally {
            clearTimeout(timeout);
        }
        return balances;
    }
    catch (e) {
        console.info(`Error querying ${name} indexer API: ${e}`);
        return null;
    }
}
async function getWalletBalances(walletAddr, network, chain, indexers) {
    if (!indexers) {
        throw new Error("Can't get balances without an indexer.");
    }
    const { goldRush, alchemy } = indexers;
    const commonConfig = { network, chain, walletAddr };
    const clientConfigs = [
        {
            ...commonConfig,
            client: goldRush?.apiKey ? new GoldRushClient_js_1.default(goldRush.apiKey) : undefined,
            name: "Gold Rush",
            timeoutMs: goldRush?.timeoutMs,
        },
        {
            ...commonConfig,
            client: alchemy?.apiKey ? new AlchemyClient_js_1.default(alchemy.apiKey) : undefined,
            name: "Alchemy",
            timeoutMs: alchemy?.timeoutMs,
        },
    ];
    for (const config of clientConfigs) {
        const result = await tryClient(config);
        if (result) {
            return result;
        }
    }
    throw new Error("Failed to get a successful response from indexers");
}
exports.getWalletBalances = getWalletBalances;
//# sourceMappingURL=balances.js.map